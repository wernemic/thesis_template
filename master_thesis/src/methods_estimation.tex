%!TEX root = ../main.tex

\chapter{Methods}

\section{Maximum likelihood estimation}
\ac{MLE} is a classical approach in machine learning.
It is used to estimate the parameters of a probability distribution based on observed data. 
The goal of \ac{MLE} is to find the parameter values that make the observed data most probable under the assumed probability distribution.
This is done by calculating the likelihood function, which is the probability of the observed data given a set of parameter values.
Likelihood can be defined as 
\begin{equation}
  \mathrm{likelihood} = p(\ \mathrm{observations } \  \boldsymbol{O} | \ \mathrm{hidden \ parameters\ } \Phi ).
  \label{eq:likelihood}
\end{equation}
We want to maximize this expression with respect to the hidden parameters.
In other words, we want to find such parameters so that they fit our observations in the best possible way.


\section{Problem formulation}
Let's divide the area of possible sources of radiation into $J$ discrete bins (indexed with $j$, where $j = 1 \dotsc J$).
Each discrete bin is represented by its center position.
We have $I$ measurements (=compton cones estimated by the compton camera), indexed with $i$, $i = 1 \dotsc I$.
Let's define matrix $\mathbf{T}$ ($\mathbf{T} \in \mathbb{R}^{I \times J}$), where each position in the matrix is defined as

\begin{equation}
  t_{ij} =  P(\textrm{detected in } i | \textrm{emitted from } j).
\end{equation}

In other words, $t_{ij}$ represents a probability that we observe observation $i$ given the fact that the radioactive particle was emitted from position $j$.

Let's assume that the number of photons emitted from one position $j$ is a discrete random variable that follows a Poisson distribution with expected value $\lambda_{j}$.
Our goal is to estimate $\mathbf{\Lambda}$, which has elements $\lambda_{j}$, each corresponding with the expected number of photons emitted from the position $j$.

The likelihood of measuring $y_{i}$ particles in the measurement bin $i$ w.r.t. $\mathbf{\Lambda}$ can be expressed as (Poisson distribution):
\begin{equation}
  p(y_{i} |\mu_{i} ) = e^{-\mu_{i}} \frac{\mu_{i}^{y_i}}{y_{i}!},
\end{equation}
where $\mu_{i} = \sum_{j} t_{ij}\lambda_{j}$ for simplicity denotes the average number of events measured in bin $i$.

The likelihood of all the measurements is
\begin{equation}  
  p(\mathbf{Y} | \mathbf{T\Lambda} ) = \prod_{i} e^{-\mu_{i}} \frac{\mu_{i}^{y_i}}{y_{i}!}.
\end{equation}

After taking its logarithm, we have the following:

\begin{equation}  
  \mathrm{log}\ p(\mathbf{Y} | \mathbf{T\Lambda} ) = \sum_{i}\left ( -\sum_{j} t_{ij}\lambda_{j} + y_{i} \mathrm{log}(\sum_{j} t_{ij}\lambda_{j})  - \mathrm{log}(y_{i}!) \right ).
  \label{eq:likelihood1}
\end{equation}
However, equation \ref{eq:likelihood1} doesn't give an answer to our question - how to determine $\mathbf{\Lambda}$. The solution is to use an iterative EM algorithm.




\section{MLEM}
\begin{equation}
\hat{\lambda}_{j}^{(l+1)} = \frac{\hat{\lambda}_{j}^{(l)}}{s_{j}} \sum_{i \in I} \frac{t_{ij}}{\sum_{k} t_{ik} \hat{\lambda}_{k}^{(l)}},
  \label{eq:MLEM}
\end{equation}

\section{System matrix}
\begin{equation}
t_{ij} =  P(\textrm{detected in } i | \textrm{emitted from } j).
\end{equation}

\begin{equation}
  t_{ij} =  (1-e^{x})  K(\beta_{i},E_{0}) \frac{}{d^{2}_{ij}} h(\delta_{ij}, \sigma),
\end{equation}


\begin{equation}
  t_{ij} =  p_{1}p_{2}p_{3}p_{4}p_{5}
\end{equation}

\begin{itemize}
  \item $p_{1}$ - probability that particle is emmitted from $j$
  \item $p_{2}$ - probability that particle reaches the detector
  \item $p_{3}$ - probability that compton effect occured
\end{itemize}


\section{Sensitivity matrix}
\begin{equation}
  s_{jv} = (1-p_{air})\frac{\mathrm{lookup}(\sigma_{jv}, \theta_{jv})}{d^{2}_{jv}}
\end{equation}


\begin{equation}
  \mathrm{lookup}(\sigma_{jv}, \theta_{jv}) = \sum_{N_{particles emitted}} N_{compton cones} 
\end{equation}

$\Delta_{v} = t_{v} - t_{v-1}$

\begin{equation}
  s_{j} = \sum_{v} s_{jv} \Delta_{v} 
\end{equation}





\begin{algorithm}
\caption{Monte-carlo simulation}\label{alg:cap}

\begin{algorithmic}

\Function {create\_lookup\_table}{$N$}
  \For {$\theta \in (0, \dots ,\pi)$}
    \For {$\sigma \in (0, \dots , 2\pi)$}
      \State $\mathrm{lookup\_table}(\theta, \sigma) \gets \Call{compute\_probability}{\theta, \sigma, N}$
    \EndFor
  \EndFor
\EndFunction

\Statex

\Function {compute\_probability}{$\theta, \sigma, N$}
\State $C \gets 0$
\State $A \gets N\frac{\Omega_{\theta, \sigma}}{4 \pi}$ \Comment{how many of $N$ particles hits the sensor}
\State $a \gets 0$
\While {$a<A$} 
  \If {\Call{is\_cone\_measured}{$\theta, \sigma$}} \Comment{Compton cone measured}
      
  \State $C \gets C + 1 $ 
  \EndIf
  \State $a \gets a + 1$
\EndWhile
  \State \Return $C/N$ 

  \EndFunction


\Statex

  \Function{is\_cone\_measured}{$\theta,\sigma$}
  \State $ray \gets \Call{sample\_sensor\_surface}{\theta,\sigma}$ \Comment{ray inside the sensor after hitting its surface}

  \If{\Call{is\_compton\_scattering}{$ray, E_{0}$}} \Comment{sample if \ac{CS} occured}
  \State $new\_ray, E_{1} \gets \Call{compton\_scattering}{ray, E_{0}}$ \Comment{Sample Klein-Nishina formula}
  \Else{}
    \State \Return False \Comment{No compton scattering occured}
  \EndIf
  
  \If{\Call{is\_photoelectric\_effect}{$new\_ray, E_{1}$}} \Comment{Sample if \ac{PE} occured} 
    \State \Return True
  \Else{}
    \State \Return False
  \EndIf
\EndFunction
\end{algorithmic}
\end{algorithm}
